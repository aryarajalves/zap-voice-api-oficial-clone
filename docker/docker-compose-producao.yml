version: "3.8"

services:
  # ==========================================
  # SERVIÇO PRINCIPAL (Backend + Frontend)
  # ==========================================
  zapvoice_app:
    image: aryarajalves/zap-voice-funil-api-oficial-zap:1.6.3
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    volumes:
      - zapvoice_uploads:/app/static/uploads
    env_file:
      - ../.env
    environment:
      - PORT=${PORT:-8000}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - VITE_API_URL=${VITE_API_URL}
      - VITE_WS_URL=${VITE_WS_URL}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-zapvoice-rabbit}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-/}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - USER_TABLE_NAME=${USER_TABLE_NAME:-users}
      - REGISTER_API_KEY=${REGISTER_API_KEY}
      - SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
      - SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=1
        - traefik.http.routers.zapvoice.rule=Host(`${DOMAIN:-seu-dominio.com}`)
        - traefik.http.routers.zapvoice.entrypoints=websecure
        - traefik.http.routers.zapvoice.tls.certresolver=letsencryptresolver
        - traefik.http.services.zapvoice.loadbalancer.server.port=8000

  # ==========================================
  # SERVIÇO WORKER (Processamento em Segundo Plano)
  # ==========================================
  zapvoice_worker:
    image: aryarajalves/zap-voice-funil-api-oficial-zap:1.6.3
    command: python worker.py
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    volumes:
      - zapvoice_uploads:/app/static/uploads
    env_file:
      - ../.env
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-zapvoice-rabbit}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-/}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

# ==========================================
# VOLUMES E REDES
# ==========================================
volumes:
  zapvoice_uploads:
    external: true
    name: zapvoice_uploads

networks:
  network_swarm_public:
    name: network_swarm_public
    external: true
