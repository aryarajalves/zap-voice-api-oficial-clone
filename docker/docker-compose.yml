version: "3.8"

services:
  zapvoice_app:
    image: ${IMAGE_NAME:-zapvoice-backend:latest}
    build:
      context: ..
      dockerfile: docker/Dockerfile
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    volumes:
      - zapvoice_uploads:/app/static/uploads
    environment:
      # === Configuração da Aplicação ===
      - PORT=${PORT:-8000}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}

      # === Frontend Runtime Config ===
      - VITE_API_URL=${VITE_API_URL}
      - VITE_WS_URL=${VITE_WS_URL}

      # === WhatsApp Oficial (Meta) ===
      - WA_BUSINESS_ACCOUNT_ID=${WA_BUSINESS_ACCOUNT_ID}
      - WA_PHONE_NUMBER_ID=${WA_PHONE_NUMBER_ID}
      - WA_ACCESS_TOKEN=${WA_ACCESS_TOKEN}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN:-zapvoice_webhook_2026}

      # === Infraestrutura Externa (Postgres/Rabbit/S3) ===
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}

      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}

      - REGISTER_API_KEY=${REGISTER_API_KEY}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=1
        - traefik.http.routers.zapvoice.rule=Host(`${DOMAIN:-seu-dominio.com}`)
        - traefik.http.routers.zapvoice.entrypoints=websecure
        - traefik.http.routers.zapvoice.tls.certresolver=letsencryptresolver
        - traefik.http.services.zapvoice.loadbalancer.server.port=8000

  zapvoice_worker:
    image: ${IMAGE_NAME:-zapvoice-backend:latest}
    command: python worker.py
    networks:
      - network_swarm_public
    volumes:
      - zapvoice_uploads:/app/static/uploads
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}

    deploy:
      mode: replicated
      replicas: 1

volumes:
  zapvoice_uploads:
    external: true
    name: zapvoice_uploads

networks:
  network_swarm_public:
    name: network_swarm_public
    external: true
