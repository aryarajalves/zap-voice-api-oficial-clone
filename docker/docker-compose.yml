version: "3.8"

services:
  zapvoice_app:
    image: ${IMAGE_NAME:-zapvoice-backend:latest}
    build:
      context: ..
      dockerfile: docker/Dockerfile
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    volumes:
      - zapvoice_uploads:/app/static/uploads
    environment:
      # === Configuração Base e Segurança ===
      - PORT=${PORT:-8000}
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}

      # === Acesso Inicial (Super Admin) ===
      # Use estes dados para seu primeiro login no sistema
      - SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
      - SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}

      # === Configuração de Registro ===
      - REGISTER_API_KEY=${REGISTER_API_KEY}

      # === Frontend Runtime Config ===
      - VITE_API_URL=${VITE_API_URL}
      - VITE_WS_URL=${VITE_WS_URL}

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=1
        - traefik.http.routers.zapvoice.rule=Host(`${DOMAIN:-seu-dominio.com}`)
        - traefik.http.routers.zapvoice.entrypoints=websecure
        - traefik.http.routers.zapvoice.tls.certresolver=letsencryptresolver
        - traefik.http.services.zapvoice.loadbalancer.server.port=8000

  zapvoice_worker:
    image: ${IMAGE_NAME:-zapvoice-backend:latest}
    command: python worker.py
    networks:
      - network_swarm_public
    volumes:
      - zapvoice_uploads:/app/static/uploads
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}

    deploy:
      mode: replicated
      replicas: 1

volumes:
  zapvoice_uploads:
    external: true
    name: zapvoice_uploads

networks:
  network_swarm_public:
    name: network_swarm_public
    external: true
